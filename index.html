<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全屋收納・專業版｜AI空間設計助手</title>
    <!-- 使用 Tailwind 與本地字體最佳化 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,400..700;1,14..32,400..700&family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', 'Inter', sans-serif; scroll-behavior: smooth; }
        .glass { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .loading-overlay {
            position: fixed; inset: 0; background: #f8fafc; z-index: 1000;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            transition: opacity 0.4s ease;
        }
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .print-break { page-break-before: always; }
        }
        .card-shadow { box-shadow: 0 20px 30px -10px rgba(0, 20, 30, 0.08); }
        .chip-glow:hover { box-shadow: 0 8px 18px -6px rgba(79, 70, 229, 0.25); }
        /* 自定義動畫 */
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 antialiased">

    <!-- 載入畫面 (初始顯示) -->
    <div id="loading" class="loading-overlay">
        <div class="w-16 h-16 bg-indigo-600 rounded-2xl flex items-center justify-center text-white mb-5 shadow-xl animate-pulse">
            <i data-lucide="package-search" class="w-8 h-8"></i>
        </div>
        <p class="text-slate-500 text-sm font-medium tracking-widest">載入收納計畫 · 同步雲端</p>
    </div>

    <!-- 導航欄 (sticky) -->
    <header class="sticky top-0 z-50 glass border-b border-white/30 no-print">
        <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2.5">
                <div class="bg-indigo-700 p-1.5 rounded-xl text-white shadow-md">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                </div>
                <span class="text-lg font-black tracking-tight text-slate-800">收納矩陣<span class="text-indigo-600 ml-1 text-sm font-bold">PRO</span></span>
            </div>
            <nav class="hidden md:flex items-center gap-1 p-1 bg-slate-100/70 rounded-full">
                <button onclick="scrollToId('space-section')" class="nav-btn text-xs font-bold px-4 py-2 rounded-full hover:bg-white transition">空間配置</button>
                <button onclick="scrollToId('storage-section')" class="nav-btn text-xs font-bold px-4 py-2 rounded-full hover:bg-white transition">尺寸錄入</button>
                <button onclick="scrollToId('summary-section')" class="nav-btn text-xs font-bold px-4 py-2 rounded-full bg-indigo-600 text-white shadow-sm">規劃報告</button>
            </nav>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-8 space-y-12">

        <!-- 儀表板小卡 -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-4 no-print">
            <div class="bg-white p-6 rounded-2xl border border-slate-100 card-shadow flex items-center gap-4">
                <div class="w-12 h-12 rounded-xl bg-indigo-50 flex items-center justify-center text-indigo-600"><i data-lucide="layers" class="w-6 h-6"></i></div>
                <div><p class="text-slate-400 text-xs font-bold mb-1">已管理空間</p><h3 id="stat-spaces" class="text-3xl font-black">0</h3></div>
            </div>
            <div class="bg-white p-6 rounded-2xl border border-slate-100 card-shadow flex items-center gap-4">
                <div class="w-12 h-12 rounded-xl bg-indigo-50 flex items-center justify-center text-indigo-600"><i data-lucide="package" class="w-6 h-6"></i></div>
                <div><p class="text-slate-400 text-xs font-bold mb-1">已錄入物品</p><h3 id="stat-items" class="text-3xl font-black">0</h3></div>
            </div>
            <div class="bg-gradient-to-br from-indigo-600 to-indigo-500 p-6 rounded-2xl shadow-xl flex items-center gap-4 text-white">
                <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center"><i data-lucide="cloud" class="w-6 h-6"></i></div>
                <div><p class="text-indigo-100 text-xs font-bold mb-1">雲端狀態</p><div class="flex items-center gap-2"><i data-lucide="check-circle-2" class="w-4 h-4"></i><span class="font-bold text-sm">自動同步即時</span></div></div>
            </div>
        </section>

        <!-- 1. 空間管理區塊 -->
        <section id="space-section">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-xl bg-indigo-100 flex items-center justify-center text-indigo-700"><i data-lucide="map-pin" class="w-4 h-4"></i></div>
                    <h2 class="text-xl font-black tracking-tight">空間管理 · 自定義分區</h2>
                </div>
                <button onclick="handleGenerateAnalysis()" id="ai-btn" class="text-xs font-bold bg-slate-900 text-white px-5 py-2.5 rounded-full flex items-center gap-2 hover:scale-105 active:scale-95 shadow-lg transition-all">
                    <i data-lucide="sparkles" class="w-3 h-3 text-yellow-400"></i> AI 動線解析
                </button>
            </div>

            <!-- AI分析結果卡片 (初始隱藏) -->
            <div id="ai-analysis-box" class="hidden mb-8 p-6 bg-gradient-to-br from-indigo-50 to-white rounded-2xl border border-indigo-200 relative overflow-hidden shadow-sm fade-in">
                <div class="absolute right-0 top-0 text-indigo-100 opacity-30"><i data-lucide="sparkles" class="w-28 h-28"></i></div>
                <h4 class="text-indigo-800 font-black text-sm flex items-center gap-2 mb-3"><i data-lucide="wand-2" class="w-4 h-4"></i> AI 專家規劃見解</h4>
                <div id="ai-text" class="text-sm text-indigo-900 whitespace-pre-line leading-relaxed relative z-10"></div>
                <button onclick="closeAiBox()" class="absolute top-4 right-4 text-indigo-400 hover:text-indigo-600 transition"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>

            <!-- 空間標籤列 (動態生成) -->
            <div id="space-list" class="flex flex-wrap gap-2"></div>

            <!-- 新增空間 UI -->
            <div id="add-space-ui" class="mt-4 hidden">
                <div class="flex gap-2 max-w-sm">
                    <input id="new-space-input" class="flex-1 px-5 py-3 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-400 bg-white" placeholder="例如: 更衣室、儲藏間">
                    <button onclick="confirmAddSpace()" class="bg-indigo-600 text-white px-6 rounded-xl font-bold shadow-sm hover:bg-indigo-700 transition">新增</button>
                    <button onclick="toggleSpaceUI(false)" class="bg-slate-100 text-slate-500 px-4 rounded-xl hover:bg-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
            </div>
            <button id="add-space-btn" onclick="toggleSpaceUI(true)" class="mt-6 border-2 border-dashed border-slate-300 py-4 rounded-2xl text-slate-400 hover:border-indigo-400 hover:text-indigo-500 hover:bg-indigo-50/30 flex items-center justify-center gap-2 w-full transition-all group no-print">
                <i data-lucide="plus" class="w-5 h-5 group-hover:scale-110"></i> 自訂新空間
            </button>
        </section>

        <!-- 2. 物品尺寸錄入 -->
        <section id="storage-section">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-9 h-9 rounded-xl bg-indigo-100 flex items-center justify-center text-indigo-700"><i data-lucide="ruler" class="w-4 h-4"></i></div>
                <h2 class="text-xl font-black tracking-tight">物品尺寸登錄 · 智慧收納建議</h2>
            </div>

            <!-- 錄入表單卡片 -->
            <div class="bg-white rounded-3xl border border-slate-100 p-6 md:p-8 card-shadow no-print mb-10">
                <div class="flex flex-col lg:flex-row gap-8">
                    <!-- 圖片上傳區 -->
                    <label class="w-full lg:w-48 h-44 bg-slate-50 border-2 border-dashed border-slate-200 rounded-2xl flex flex-col items-center justify-center cursor-pointer overflow-hidden relative group hover:border-indigo-400 transition">
                        <div id="img-preview-container" class="absolute inset-0 hidden bg-cover bg-center">
                            <img id="item-img-preview" src="" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex items-center justify-center text-white transition"><i data-lucide="refresh-cw" class="w-5 h-5"></i></div>
                        </div>
                        <div id="img-placeholder" class="text-center p-4">
                            <div class="w-12 h-12 bg-indigo-50 text-indigo-400 rounded-xl flex items-center justify-center mx-auto mb-2"><i data-lucide="image" class="w-5 h-5"></i></div>
                            <span class="text-[10px] font-bold text-slate-400 uppercase">點擊上傳照片</span>
                        </div>
                        <input type="file" id="image-input" class="hidden" accept="image/*" onchange="previewImage(this)">
                    </label>

                    <!-- 表單欄位 (3+1) -->
                    <div class="flex-1 grid grid-cols-2 md:grid-cols-4 gap-4 items-end">
                        <div class="col-span-2">
                            <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">放置空間</label>
                            <select id="item-space" class="w-full p-4 border border-slate-200 rounded-xl bg-white outline-none focus:ring-2 focus:ring-indigo-400 font-medium"></select>
                        </div>
                        <div class="col-span-2">
                            <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">物品名稱</label>
                            <input id="item-name" class="w-full p-4 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-400" placeholder="eg. 除濕機">
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">長(cm)</label>
                            <input id="item-l" type="number" class="w-full p-4 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-400">
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">寬(cm)</label>
                            <input id="item-w" type="number" class="w-full p-4 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-400">
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">高(cm)</label>
                            <input id="item-h" type="number" class="w-full p-4 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-400">
                        </div>
                        <div>
                            <button onclick="handleAddItem()" class="w-full bg-indigo-600 text-white h-[58px] rounded-xl font-bold shadow-md hover:bg-indigo-700 active:scale-95 transition-all flex items-center justify-center gap-1"><i data-lucide="save" class="w-4 h-4"></i> 儲存</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 物品卡片網格 -->
            <div id="item-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5"></div>
        </section>

        <!-- 3. 最終報告區 (列印/檢視) -->
        <section id="summary-section" class="pt-6">
            <div class="bg-white rounded-[40px] border border-slate-200 p-8 md:p-12 shadow-2xl print:shadow-none print:border-0 relative overflow-hidden">
                <!-- 頁眉 -->
                <div class="flex flex-col md:flex-row justify-between items-start mb-10 no-print">
                    <div>
                        <span class="inline-block bg-indigo-600 text-white text-[10px] font-black px-3 py-1 rounded-full mb-4">正式規劃報告</span>
                        <h2 class="text-4xl font-black text-slate-800 tracking-tight">收納設計需求書</h2>
                        <p class="text-sm text-slate-400 mt-3 flex items-center gap-2"><i data-lucide="fingerprint" class="w-4 h-4"></i> 專案ID: <span id="uid-display" class="font-mono text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded">---</span> · <span id="current-date"></span></p>
                    </div>
                    <button onclick="window.print()" class="mt-6 md:mt-0 bg-slate-900 text-white px-8 py-4 rounded-2xl font-bold flex items-center gap-3 shadow-xl hover:bg-slate-800 transition"><i data-lucide="printer" class="w-5 h-5"></i> 列印 / PDF</button>
                </div>

                <!-- 動態報告內容 (依空間分組) -->
                <div id="report-content" class="space-y-14 print:space-y-10"></div>

                <!-- 頁尾備註 -->
                <div class="mt-16 pt-6 border-t border-slate-100 flex justify-between text-slate-400 text-[9px] font-bold uppercase tracking-widest no-print">
                    <span>© 2025 收納矩陣 PRO · 數據即時同步</span>
                    <span class="italic">建議預留 5% 施工公差</span>
                </div>
            </div>
        </section>
    </main>

    <!-- Firebase 與應用程式核心 (模組方式) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ---------- 此處應由後端注入 ----------
        // 模擬 __firebase_config 與 __app_id (在正式環境請務必替換為真實config)
        const firebaseConfig = {
            apiKey: "AIzaSyA_dummy_key_for_demo_purposes_only",
            authDomain: "dummy-project.firebaseapp.com",
            projectId: "dummy-project",
            storageBucket: "dummy-project.appspot.com",
            messagingSenderId: "000000000000",
            appId: "1:000000000000:web:abcdef"
        };
        const __app_id = 'reno-planner-pro-v2';
        // 可選匿名token (模擬)
        const __initial_auth_token = null; 
        // ---------- 模擬區結束 ----------

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = __app_id;

        // 全域狀態
        let state = {
            user: null,
            spaces: ['玄關', '客廳', '主臥', '廚房', '衛浴'], // 初始空間
            items: [],
            aiSuggestions: {},  // 每個item id對應一句AI建議
            isWriting: false,
            currentImage: null
        };

        // DOM 元素快取
        const statSpaces = document.getElementById('stat-spaces');
        const statItems = document.getElementById('stat-items');
        const spaceListEl = document.getElementById('space-list');
        const spaceSelect = document.getElementById('item-space');
        const itemGrid = document.getElementById('item-grid');
        const reportContent = document.getElementById('report-content');
        const loading = document.getElementById('loading');
        const uidSpan = document.getElementById('uid-display');
        const currentDateSpan = document.getElementById('current-date');

        // 輔助：更新統計
        const updateStats = () => {
            statSpaces.innerText = state.spaces.length;
            statItems.innerText = state.items.length;
        };

        // 渲染整個UI (空間標籤、選單、物品卡、報告)
        const render = () => {
            updateStats();

            // 1. 空間標籤
            spaceListEl.innerHTML = state.spaces.map(s => 
                `<span class="inline-flex items-center gap-1.5 px-4 py-2 bg-white border border-slate-200 rounded-full text-sm font-bold shadow-sm chip-glow transition"><span class="w-2 h-2 rounded-full bg-indigo-500"></span>${s}</span>`
            ).join('');

            // 2. 空間下拉選單 (保留之前選擇的值)
            const prevSpace = spaceSelect.value;
            spaceSelect.innerHTML = state.spaces.map(s => `<option value="${s}" ${s === prevSpace ? 'selected' : ''}>${s}</option>`).join('');

            // 3. 物品卡片
            itemGrid.innerHTML = state.items.map(item => `
                <div class="bg-white border border-slate-100 rounded-3xl p-5 card-shadow hover:border-indigo-200 transition-all fade-in">
                    <div class="flex gap-4">
                        <div class="w-20 h-20 rounded-xl bg-slate-100 border border-slate-100 overflow-hidden flex-shrink-0">
                            ${item.image ? `<img src="${item.image}" class="w-full h-full object-cover">` : 
                            `<div class="w-full h-full flex items-center justify-center text-slate-300"><i data-lucide="camera-off" class="w-5 h-5"></i></div>`}
                        </div>
                        <div class="flex-1">
                            <div class="flex items-start justify-between">
                                <span class="text-[9px] font-black text-indigo-600 px-2 py-0.5 bg-indigo-50 rounded-full">${item.space}</span>
                                <button onclick="removeItem(${item.id})" class="text-slate-300 hover:text-red-500"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                            </div>
                            <h3 class="font-bold text-base mt-1 truncate">${item.name}</h3>
                            <div class="flex gap-2 text-[10px] font-mono text-slate-500 mt-1">
                                <span class="bg-slate-100 px-2 py-0.5 rounded">L:${item.l}</span>
                                <span class="bg-slate-100 px-2 py-0.5 rounded">W:${item.w}</span>
                                <span class="bg-slate-100 px-2 py-0.5 rounded">H:${item.h}</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-slate-100">
                        ${state.aiSuggestions[item.id] ? 
                            `<div class="text-xs p-2 bg-indigo-50 rounded-xl text-indigo-700 italic"><span class="font-black flex items-center gap-1 text-[9px] uppercase"><i data-lucide="sparkles" class="w-3 h-3"></i>AI 建議</span> ${state.aiSuggestions[item.id]}</div>` : 
                            `<button onclick="getAiItemSuggestion(${item.id})" class="w-full py-2 text-[10px] font-bold text-indigo-400 hover:bg-indigo-50 flex items-center justify-center gap-1 rounded-lg"><i data-lucide="sparkles" class="w-3 h-3"></i> 取得收納建議</button>`
                        }
                    </div>
                </div>
            `).join('');

            // 4. 報告區 (依空間群組)
            if (state.items.length === 0) {
                reportContent.innerHTML = `<div class="py-24 text-center border-2 border-dashed border-slate-200 rounded-[40px]"><i data-lucide="archive" class="w-12 h-12 text-slate-200 mx-auto mb-4"></i><p class="text-slate-300 font-bold">尚未錄入任何物品</p></div>`;
            } else {
                const usedSpaces = [...new Set(state.items.map(i => i.space))];
                reportContent.innerHTML = usedSpaces.map(space => {
                    const items = state.items.filter(i => i.space === space);
                    return `
                        <div class="print-break">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="w-8 h-8 rounded-lg bg-indigo-100 text-indigo-700 flex items-center justify-center font-black">${space[0]}</div>
                                <h3 class="text-2xl font-black text-slate-800">${space} <span class="text-sm text-slate-400 font-medium ml-2">(${items.length}件)</span></h3>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                                ${items.map(item => `
                                    <div class="flex gap-4">
                                        <div class="w-16 h-16 rounded-xl bg-slate-50 border border-slate-100 overflow-hidden flex-shrink-0">${item.image ? `<img src="${item.image}" class="object-cover w-full h-full">` : ''}</div>
                                        <div><p class="font-black text-sm">${item.name}</p><div class="text-[10px] space-y-0.5 mt-1 text-slate-500"><span class="block">長 ${item.l} cm</span><span>寬 ${item.w} cm</span><span>高 ${item.h} cm</span></div></div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // 重新生成lucide圖標
            lucide.createIcons();
        };

        // ---------- Firebase 同步 ----------
        const syncToCloud = async () => {
            if (!state.user) return;
            state.isWriting = true;
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'plan_v1');
                await setDoc(docRef, {
                    spaces: state.spaces,
                    items: state.items,
                    updatedAt: Date.now()
                });
            } catch (err) { console.warn("sync error", err); }
            setTimeout(() => { state.isWriting = false; }, 600);
        };

        // ---------- 全域函數 (需掛載window) ----------
        window.scrollToId = (id) => document.getElementById(id).scrollIntoView({ behavior: 'smooth' });

        window.toggleSpaceUI = (show) => {
            document.getElementById('add-space-ui').classList.toggle('hidden', !show);
            document.getElementById('add-space-btn').classList.toggle('hidden', show);
            if (show) document.getElementById('new-space-input').focus();
        };

        window.confirmAddSpace = () => {
            const input = document.getElementById('new-space-input');
            const val = input.value.trim();
            if (val && !state.spaces.includes(val)) {
                state.spaces.push(val);
                input.value = '';
                toggleSpaceUI(false);
                render();
                syncToCloud();
            } else { alert('名稱無效或已存在'); }
        };

        window.previewImage = (input) => {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    state.currentImage = e.target.result;
                    document.getElementById('img-preview-container').classList.remove('hidden');
                    document.getElementById('item-img-preview').src = e.target.result;
                    document.getElementById('img-placeholder').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        };

        window.handleAddItem = () => {
            const name = document.getElementById('item-name').value.trim();
            if (!name) return alert('請輸入物品名稱');
            const newItem = {
                id: Date.now() + Math.floor(Math.random()*100),
                name,
                space: document.getElementById('item-space').value,
                l: document.getElementById('item-l').value || 0,
                w: document.getElementById('item-w').value || 0,
                h: document.getElementById('item-h').value || 0,
                image: state.currentImage
            };
            state.items.unshift(newItem);
            // 清空表單
            document.getElementById('item-name').value = '';
            document.getElementById('item-l').value = '';
            document.getElementById('item-w').value = '';
            document.getElementById('item-h').value = '';
            state.currentImage = null;
            document.getElementById('img-preview-container').classList.add('hidden');
            document.getElementById('img-placeholder').classList.remove('hidden');
            render();
            syncToCloud();
        };

        window.removeItem = (id) => {
            if (confirm('確定刪除此物品？')) {
                state.items = state.items.filter(i => i.id !== id);
                render();
                syncToCloud();
            }
        };

        // AI 分析 (使用Gemini風格，但此處為模擬)
        window.handleGenerateAnalysis = async () => {
            const btn = document.getElementById('ai-btn');
            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="refresh-cw" class="w-3 h-3 animate-spin"></i> 分析中...`;
            lucide.createIcons();

            // 模擬API延遲 (實際應呼叫gemini)
            setTimeout(() => {
                const mockAnalysis = `✨ 根據您收納的物品分佈，建議在「玄關」增加懸空櫃，深度35cm以容納小型電器。客廳區域目前有3件較高物品(>40cm)，可考慮整合垂直收納。主臥衣物區可劃分吊掛與摺疊區，預留60cm寬度。整體動線建議保持90cm以上通道。`;
                document.getElementById('ai-text').innerText = mockAnalysis;
                document.getElementById('ai-analysis-box').classList.remove('hidden');
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="sparkles" class="w-3 h-3 text-yellow-400"></i> AI 空間動線分析`;
                lucide.createIcons();
                window.scrollToId('ai-analysis-box');
            }, 1500);
        };

        window.getAiItemSuggestion = async (itemId) => {
            const item = state.items.find(i => i.id === itemId);
            if (!item) return;
            // 模擬AI建議
            setTimeout(() => {
                state.aiSuggestions[itemId] = `「${item.name}」可搭配抽屜式收納盒，利用高度剩餘空間堆疊。`;
                render();
            }, 800);
        };

        window.closeAiBox = () => document.getElementById('ai-analysis-box').classList.add('hidden');

        // ---------- 初始化與Firebase即時監聽 ----------
        const initApp = async () => {
            currentDateSpan.innerText = new Date().toLocaleDateString('zh-TW', { year:'numeric', month:'long', day:'numeric' });

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    state.user = user;
                    uidSpan.innerText = user.uid.slice(-6);
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'plan_v1');
                    onSnapshot(docRef, (snap) => {
                        if (state.isWriting) return;
                        if (snap.exists()) {
                            const data = snap.data();
                            state.spaces = data.spaces || state.spaces;
                            state.items = data.items || [];
                            render();
                        } else {
                            // 若無文件，以初始狀態渲染並同步一次
                            render();
                            syncToCloud();
                        }
                        loading.style.opacity = '0';
                        setTimeout(() => loading.style.display = 'none', 400);
                    }, (err) => {
                        console.warn("snapshot err", err);
                        loading.style.display = 'none';
                        render();
                    });
                } else {
                    await signInAnonymously(auth);
                }
            });

            setTimeout(() => {
                if (loading.style.display !== 'none') {
                    loading.style.display = 'none';
                }
            }, 4000);
        };

        initApp();
        render(); // 初始渲染
    </script>
</body>
</html>